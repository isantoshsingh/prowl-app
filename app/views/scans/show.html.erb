<%# Scan Detail — Polaris Web Components (Built for Shopify) %>

<s-page heading="Scan #<%= @scan.id %>">
  <s-link slot="primary-action" href="<%= product_page_path(@product_page, host: @host) %>">View Product Page</s-link>
  <s-link slot="breadcrumb-actions" href="<%= scans_path(host: @host) %>">Scan history</s-link>
  <s-badge slot="accessory" tone="<%= @scan.status == 'completed' ? 'success' : (@scan.status == 'failed' ? 'critical' : 'info') %>"><%= @scan.status.capitalize %></s-badge>
</s-page>

<!-- Scan Summary -->
<s-section heading="Scan summary">
  <s-grid gridTemplateColumns="repeat(4, 1fr)" gap="base">
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Status</s-paragraph>
      <s-badge tone="<%= @scan.status == 'completed' ? 'success' : (@scan.status == 'failed' ? 'critical' : 'info') %>"><%= @scan.status.capitalize %></s-badge>
    </s-stack>
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Page load time</s-paragraph>
      <strong>
        <% if @scan.page_load_time_ms %>
        <%= (@scan.page_load_time_ms / 1000.0).round(2) %>s
        <% else %>
        —
        <% end %>
      </strong>
    </s-stack>
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Issues found</s-paragraph>
      <s-stack direction="inline" gap="tight" align="center">
        <strong><%= @issues.count %></strong>
        <% if @issues.any? %>
        <s-icon type="alert-circle" tone="critical"></s-icon>
        <% end %>
      </s-stack>
    </s-stack>
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Duration</s-paragraph>
      <strong>
        <% if @scan.duration_seconds %>
        <%= @scan.duration_seconds %>s
        <% else %>
        —
        <% end %>
      </strong>
    </s-stack>
  </s-grid>
</s-section>

<s-box paddingBlockStart="base">
  <s-section heading="Scan details">
    <s-grid gridTemplateColumns="repeat(2, 1fr)" gap="base">
      <s-stack direction="block" gap="extra-tight">
        <s-paragraph>Product</s-paragraph>
        <s-link href="<%= product_page_path(@product_page, host: @host) %>"><%= @product_page.title %></s-link>
      </s-stack>
      <s-stack direction="block" gap="extra-tight">
        <s-paragraph>Scanned at</s-paragraph>
        <strong><%= @scan.created_at.strftime("%B %d, %Y at %H:%M") %></strong>
      </s-stack>
    </s-grid>
  </s-section>
</s-box>

<% if @scan.status == 'failed' && @scan.error_message.present? %>
<s-box paddingBlockStart="base">
  <s-banner tone="critical" accessibilityLabel="Scan failed">
    <s-stack direction="block" gap="tight">
      <strong>Scan failed</strong>
      <s-paragraph><%= @scan.error_message %></s-paragraph>
    </s-stack>
  </s-banner>
</s-box>
<% end %>

<!-- Issues from this scan -->
<s-box paddingBlockStart="base">
  <s-section heading="Issues detected">
    <% if @issues.any? %>
    <s-stack gap="none">
      <% @issues.each do |issue| %>
      <%= link_to issue_path(issue, host: @host), style: "display: block; text-decoration: none; color: inherit;" do %>
      <s-box border="base" padding="base">
        <s-grid gridTemplateColumns="1fr auto" gap="base" alignItems="center">
          <s-stack direction="block" gap="extra-tight">
            <strong><%= issue.title %></strong>
            <s-stack direction="inline" gap="tight" align="center">
              <s-badge tone="<%= issue.severity == 'high' ? 'critical' : (issue.severity == 'medium' ? 'warning' : 'attention') %>"><%= issue.severity_label %></s-badge>
              <s-paragraph><%= issue.status.capitalize %></s-paragraph>
            </s-stack>
          </s-stack>
          <s-paragraph>View →</s-paragraph>
        </s-grid>
      </s-box>
      <% end %>
      <% end %>
    </s-stack>
    <% else %>
    <s-grid gap="base" justifyItems="center" paddingBlock="large-400">
      <s-box maxInlineSize="120px" maxBlockSize="120px">
        <s-icon type="check-circle-filled" tone="success"></s-icon>
      </s-box>
      <s-grid justifyItems="center" maxInlineSize="450px" gap="base">
        <s-stack align="center" gap="tight">
          <s-heading>No issues detected</s-heading>
          <s-paragraph>This scan completed without finding any problems.</s-paragraph>
        </s-stack>
      </s-grid>
    </s-grid>
    <% end %>
  </s-section>
</s-box>

<% if @scan.status == 'completed' %>
<s-box paddingBlockStart="base">
  <s-section heading="Technical details">
    <% if @scan.has_js_errors? %>
    <s-box paddingBlockStart="base">
      <s-stack direction="block" gap="tight">
        <s-paragraph><strong>JavaScript Errors (<%= @scan.parsed_js_errors.count %>)</strong></s-paragraph>
        <s-box background="subdued" padding="base" borderRadius="base">
          <pre style="margin: 0; overflow-x: auto; font-size: 12px; white-space: pre-wrap; word-break: break-all;"><%= @scan.parsed_js_errors.map { |e| e["message"] }.join("\n") %></pre>
        </s-box>
      </s-stack>
    </s-box>
    <% end %>

    <% if @scan.has_network_errors? %>
    <s-box paddingBlockStart="base">
      <s-stack direction="block" gap="tight">
        <s-paragraph><strong>Network Errors (<%= @scan.parsed_network_errors.count %>)</strong></s-paragraph>
        <s-box background="subdued" padding="base" borderRadius="base">
          <pre style="margin: 0; overflow-x: auto; font-size: 12px; white-space: pre-wrap; word-break: break-all;"><%= @scan.parsed_network_errors.map { |e| "#{e['url']}: #{e['failure']}" }.join("\n") %></pre>
        </s-box>
      </s-stack>
    </s-box>
    <% end %>

    <% unless @scan.has_js_errors? || @scan.has_network_errors? %>
    <s-paragraph>No JavaScript or network errors captured during this scan.</s-paragraph>
    <% end %>
  </s-section>
</s-box>
<% end %>