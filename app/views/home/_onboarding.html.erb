<%# Onboarding Setup Guide — Planet-style collapsible design %>
<%# Single card with inline steps, dashed circle indicators, and expandable content %>

<s-page heading="Welcome to Prowl">
  <s-button slot="primary-action" variant="primary" href="<%= product_pages_path(host: @host) %>">
    Get started
  </s-button>
</s-page>

<%# Welcome hero section %>
<s-section>
  <s-grid gridTemplateColumns="1fr auto" gap="base" alignItems="center">
    <s-stack direction="block" gap="base">
      <s-heading>Protect your revenue from silent PDP failures</s-heading>
      <s-paragraph>
        Prowl monitors your product pages for JavaScript errors, broken UI elements, and performance issues that silently prevent customers from buying. Set up in minutes.
      </s-paragraph>
    </s-stack>
    <s-box maxInlineSize="120px">
      <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto;">
        <rect x="10" y="20" width="100" height="80" rx="8" fill="#F6F0FD" stroke="#8C6BB1" stroke-width="2"/>
        <rect x="20" y="32" width="60" height="8" rx="2" fill="#8C6BB1" opacity="0.3"/>
        <rect x="20" y="46" width="40" height="6" rx="2" fill="#8C6BB1" opacity="0.2"/>
        <rect x="20" y="58" width="50" height="6" rx="2" fill="#8C6BB1" opacity="0.2"/>
        <circle cx="85" cy="70" r="18" fill="#D4BFEA" stroke="#8C6BB1" stroke-width="2"/>
        <path d="M78 70 L83 75 L92 65" stroke="#6B3FA0" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </s-box>
  </s-grid>
</s-section>

<%# Setup guide — Planet-style single card with collapsible steps %>
<% first_incomplete = @onboarding_steps.index { |s| !s[:completed] } %>

<s-box paddingBlockStart="base">
  <div class="onboarding-card">
    <%# Card header with title, progress, and dismiss button %>
    <div class="onboarding-card-header">
      <div class="onboarding-card-header-text">
        <div class="onboarding-card-title">Setup guide</div>
        <div class="onboarding-card-subtitle">Get started using Prowl to protect your revenue.</div>
      </div>
      <div class="onboarding-card-header-right">
        <div class="onboarding-card-progress">
          <span class="onboarding-card-progress-text">
            <%= @onboarding_progress[:completed] %>/<%= @onboarding_progress[:total] %> completed
          </span>
          <div class="onboarding-progress-bar">
            <div class="onboarding-progress-fill" style="width: <%= (@onboarding_progress[:completed].to_f / @onboarding_progress[:total] * 100).round %>%"></div>
          </div>
        </div>
        <button class="onboarding-close-btn" id="dismiss-onboarding-btn" type="button" aria-label="Dismiss setup guide">
          <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
            <path d="M6.707 5.293a1 1 0 0 0-1.414 1.414L8.586 10l-3.293 3.293a1 1 0 1 0 1.414 1.414L10 11.414l3.293 3.293a1 1 0 0 0 1.414-1.414L11.414 10l3.293-3.293a1 1 0 0 0-1.414-1.414L10 8.586 6.707 5.293Z"/>
          </svg>
        </button>
      </div>
    </div>

    <%# Collapsible steps %>
    <% @onboarding_steps.each_with_index do |step, index| %>
      <div class="onboarding-card-divider"></div>
      <% is_expanded = !step[:completed] && index == first_incomplete %>
      <div class="onboarding-step-row <%= 'onboarding-step-row--expanded' if is_expanded %>"
           id="onboarding-step-<%= step[:key] %>"
           data-step-key="<%= step[:key] %>"
           data-completed="<%= step[:completed] %>">

        <%# Step header — always visible %>
        <div class="onboarding-step-header" onclick="toggleOnboardingStep('<%= step[:key] %>')">
          <% if step[:completed] %>
            <svg class="onboarding-check-icon" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-label="Completed">
              <circle cx="10" cy="10" r="10" fill="#29845a"/>
              <path d="M6 10.5l2.5 2.5 5.5-5.5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% else %>
            <div class="onboarding-circle-indicator"></div>
          <% end %>
          <span class="onboarding-step-title"><%= step[:title] %></span>
        </div>

        <%# Expandable body — hidden by default unless active %>
        <% unless step[:completed] %>
          <div class="onboarding-step-body" id="onboarding-content-<%= step[:key] %>" style="<%= is_expanded ? '' : 'display: none;' %>">
            <div class="onboarding-step-body-inner">
              <s-paragraph><%= step[:description] %></s-paragraph>
              <div class="onboarding-step-actions">
                <% case step[:key] %>
                <% when :add_products %>
                  <s-button variant="primary" href="<%= product_pages_path(host: @host) %>">
                    Add product pages
                  </s-button>
                <% when :first_scan %>
                  <% if @total_pages > 0 %>
                    <s-paragraph>
                      You have <strong><%= @total_pages %></strong> product <%= @total_pages == 1 ? 'page' : 'pages' %> added. Go to your monitored pages to trigger a scan.
                    </s-paragraph>
                    <s-button variant="primary" href="<%= product_pages_path(host: @host) %>">
                      View monitored pages
                    </s-button>
                  <% else %>
                    <s-banner tone="info">
                      <s-paragraph>Complete step 1 first to add product pages, then you can run a scan.</s-paragraph>
                    </s-banner>
                  <% end %>
                <% when :configure_alerts %>
                  <s-button variant="primary" href="<%= settings_path(host: @host) %>">
                    Configure alerts
                  </s-button>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

  </div>
</s-box>

<%# What we detect section %>
<s-box paddingBlockStart="base">
  <s-section heading="What we detect">
    <s-grid gridTemplateColumns="repeat(2, 1fr)" gap="base">
      <s-stack direction="inline" gap="base-tight" align="start">
        <s-icon type="check-circle" tone="success"></s-icon>
        <s-stack direction="block" gap="extra-tight">
          <s-paragraph><strong>Missing add-to-cart</strong></s-paragraph>
          <s-paragraph>Detect when the buy button is broken or missing</s-paragraph>
        </s-stack>
      </s-stack>

      <s-stack direction="inline" gap="base-tight" align="start">
        <s-icon type="check-circle" tone="success"></s-icon>
        <s-stack direction="block" gap="extra-tight">
          <s-paragraph><strong>JavaScript errors</strong></s-paragraph>
          <s-paragraph>Find console errors that break functionality</s-paragraph>
        </s-stack>
      </s-stack>

      <s-stack direction="inline" gap="base-tight" align="start">
        <s-icon type="check-circle" tone="success"></s-icon>
        <s-stack direction="block" gap="extra-tight">
          <s-paragraph><strong>Broken images and prices</strong></s-paragraph>
          <s-paragraph>Catch missing product images and price displays</s-paragraph>
        </s-stack>
      </s-stack>

      <s-stack direction="inline" gap="base-tight" align="start">
        <s-icon type="check-circle" tone="success"></s-icon>
        <s-stack direction="block" gap="extra-tight">
          <s-paragraph><strong>Slow page loads</strong></s-paragraph>
          <s-paragraph>Monitor performance that impacts conversions</s-paragraph>
        </s-stack>
      </s-stack>
    </s-grid>
  </s-section>
</s-box>

<% content_for :javascript do %>
<script>
  function toggleOnboardingStep(key) {
    const stepRow = document.querySelector('[data-step-key="' + key + '"]');
    if (!stepRow || stepRow.dataset.completed === 'true') return;

    const content = document.getElementById('onboarding-content-' + key);
    if (!content) return;

    const isHidden = content.style.display === 'none';

    // Collapse all steps
    document.querySelectorAll('.onboarding-step-body').forEach(function(el) {
      el.style.display = 'none';
    });
    document.querySelectorAll('.onboarding-step-row').forEach(function(el) {
      el.classList.remove('onboarding-step-row--expanded');
    });

    // Expand clicked step (if it was collapsed)
    if (isHidden) {
      content.style.display = '';
      stepRow.classList.add('onboarding-step-row--expanded');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    var dismissBtn = document.getElementById('dismiss-onboarding-btn');
    if (dismissBtn) {
      dismissBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        var csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

        try {
          var headers = {
            'X-CSRF-Token': csrfToken,
            'Accept': 'text/html'
          };

          try {
            var token = await shopify.idToken();
            if (token) headers['Authorization'] = 'Bearer ' + token;
          } catch (tokenErr) {
            console.warn('Could not get session token:', tokenErr);
          }

          var response = await fetch('<%= dismiss_onboarding_path(host: @host) %>', {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin',
            redirect: 'manual'
          });

          if (response.ok || response.type === 'opaqueredirect' || (response.status >= 300 && response.status < 400)) {
            shopify.toast.show('Setup guide dismissed', { duration: 3000 });
            setTimeout(function() { window.location.reload(); }, 500);
          } else {
            throw new Error('Server returned ' + response.status);
          }
        } catch (error) {
          console.error('Failed to dismiss onboarding:', error);
          shopify.toast.show('Failed to dismiss. Please try again.', { duration: 3000, isError: true });
        }
      });
    }
  });
</script>
<% end %>
