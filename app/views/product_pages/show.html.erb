<%# Product Page Detail %>

<s-page heading="<%= @product_page.title %>">
  <s-button slot="primary-action" onclick="document.getElementById('rescan-form').submit()">Rescan Now</s-button>
  <s-link slot="breadcrumb-actions" href="<%= product_pages_path(host: @host) %>">Monitored Pages</s-link>
  <s-badge slot="accessory" tone="<%= @product_page.status == 'healthy' ? 'success' : (@product_page.status == 'critical' ? 'critical' : 'warning') %>"><%= @product_page.status.capitalize %></s-badge>
</s-page>

<!-- Hidden rescan form for the button -->
<%= form_with url: rescan_product_page_path(@product_page, host: @host), method: :post, id: "rescan-form", style: "display: none;" do %>
<% end %>

<!-- Stats Cards -->
<div class="card-grid" style="margin-bottom: 24px;">
  <div class="stat-card">
    <h3 class="stat-card-title">Status</h3>
    <p class="stat-card-value" style="font-size: 24px;">
      <span class="badge badge-<%= @product_page.status == 'healthy' ? 'healthy' : (@product_page.status == 'critical' ? 'critical' : 'warning') %>" style="font-size: 16px; padding: 4px 12px;">
        <%= @product_page.status.capitalize %>
      </span>
    </p>
  </div>
  
  <div class="stat-card">
    <h3 class="stat-card-title">Last Scanned</h3>
    <p class="stat-card-value" style="font-size: 24px;">
      <% if @product_page.last_scanned_at %>
        <%= time_ago_in_words(@product_page.last_scanned_at) %> ago
      <% else %>
        Never
      <% end %>
    </p>
  </div>
  
  <div class="stat-card">
    <h3 class="stat-card-title">Open Issues</h3>
    <p class="stat-card-value <%= @open_issues.count > 0 ? 'critical' : 'healthy' %>">
      <%= @open_issues.count %>
    </p>
  </div>
  
  <div class="stat-card">
    <h3 class="stat-card-title">Total Scans</h3>
    <p class="stat-card-value"><%= @product_page.scans.count %></p>
  </div>
</div>

<!-- Open Issues -->
<div class="issues-list" style="margin-bottom: 24px;">
  <div class="issues-list-header">
    <h2 class="issues-list-title">Open Issues (<%= @open_issues.count %>)</h2>
  </div>
  
  <% if @open_issues.any? %>
    <% @open_issues.each do |issue| %>
      <%= link_to issue_path(issue, host: @host), class: "issue-item" do %>
        <div class="issue-severity <%= issue.severity %>"></div>
        <div class="issue-content">
          <p class="issue-title"><%= issue.title %></p>
          <p class="issue-meta">
            <%= issue.severity_label %> ‚Ä¢ 
            First detected <%= time_ago_in_words(issue.first_detected_at) %> ago
            <% if issue.occurrence_count > 1 %>
              ‚Ä¢ Seen <%= issue.occurrence_count %> times
            <% end %>
          </p>
        </div>
        <span class="badge badge-<%= issue.severity == 'high' ? 'critical' : issue.severity %>">
          View Details ‚Üí
        </span>
      <% end %>
    <% end %>
  <% else %>
    <div class="empty-state">
      <div class="empty-state-icon">‚úì</div>
      <h3 class="empty-state-title">No open issues</h3>
      <p class="empty-state-description">This product page is healthy.</p>
    </div>
  <% end %>
</div>

<!-- Recent Scans -->
<div class="issues-list">
  <div class="issues-list-header">
    <h2 class="issues-list-title">Recent Scans</h2>
  </div>
  
  <% if @recent_scans.any? %>
    <% @recent_scans.each do |scan| %>
      <%= link_to scan_path(scan, host: @host), class: "issue-item" do %>
        <div class="issue-severity <%= scan.status == 'completed' ? 'medium' : (scan.status == 'failed' ? 'high' : 'low') %>"></div>
        <div class="issue-content">
          <p class="issue-title">Scan #<%= scan.id %></p>
          <p class="issue-meta">
            <%= scan.status.capitalize %> ‚Ä¢ 
            <%= time_ago_in_words(scan.created_at) %> ago
            <% if scan.page_load_time_ms %>
              ‚Ä¢ <%= (scan.page_load_time_ms / 1000.0).round(1) %>s load time
            <% end %>
            <% if scan.issues.any? %>
              ‚Ä¢ <%= scan.issues.count %> issue<%= scan.issues.count > 1 ? 's' : '' %> detected
            <% end %>
          </p>
        </div>
        <span class="badge badge-<%= scan.status == 'completed' ? 'healthy' : (scan.status == 'failed' ? 'critical' : 'pending') %>">
          <%= scan.status.capitalize %>
        </span>
      <% end %>
    <% end %>
  <% else %>
    <div class="empty-state">
      <div class="empty-state-icon">üîç</div>
      <h3 class="empty-state-title">No scans yet</h3>
      <p class="empty-state-description">The first scan will run automatically soon.</p>
    </div>
  <% end %>
</div>
