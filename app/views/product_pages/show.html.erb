<%# Product Page Detail — Polaris Web Components (Built for Shopify) %>

<s-page heading="<%= @product_page.title %>">
  <s-button slot="primary-action" onclick="rescanNow(this)" id="rescan-btn" <%= 'loading' if @scanning %>>Rescan now</s-button>
  <s-link slot="breadcrumb-actions" href="<%= product_pages_path(host: @host) %>">Monitored Pages</s-link>
  <s-badge slot="accessory" tone="<%= @product_page.status == 'healthy' ? 'success' : (@product_page.status == 'critical' ? 'critical' : 'warning') %>"><%= @product_page.status.capitalize %></s-badge>
</s-page>

<%# Hidden config for JS — status polling URL and initial scan state %>
<div id="status-config"
     data-status-url="<%= status_product_page_path(@product_page, host: @host) %>"
     data-rescan-url="<%= rescan_product_page_path(@product_page, host: @host) %>"
     data-csrf="<%= form_authenticity_token %>"
     data-scanning="<%= @scanning %>"
     style="display: none;">
</div>

<% if @scanning %>
<%# Scanning banner — only rendered when a scan is in-progress at page load %>
<s-box paddingBlockEnd="base">
  <s-banner tone="info">
    <s-stack direction="inline" alignItems="center" gap="base">
      <s-spinner accessibilityLabel="Scan in progress"></s-spinner>
      <s-stack direction="block" gap="extra-tight">
        <strong>Scan in progress</strong>
        <s-paragraph>The page is being scanned for issues. Results will appear automatically when complete.</s-paragraph>
      </s-stack>
    </s-stack>
  </s-banner>
</s-box>
<% end %>


<!-- Stats -->
<s-section heading="Overview">
  <s-grid gridTemplateColumns="repeat(4, 1fr)" gap="base">
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Status</s-paragraph>
      <s-badge tone="<%= @product_page.status == 'healthy' ? 'success' : (@product_page.status == 'critical' ? 'critical' : 'warning') %>"><%= @product_page.status.capitalize %></s-badge>
    </s-stack>
    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Last Scanned</s-paragraph>
      <strong>
        <% if @product_page.last_scanned_at %>
        <%= time_ago_in_words(@product_page.last_scanned_at) %> ago
        <% else %>
        Never
        <% end %>
      </strong>
    </s-stack>

    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Open Issues</s-paragraph>
      <s-stack direction="inline" gap="tight" align="center">
        <strong><%= @open_issues.count %></strong>
        <% if @open_issues.count > 0 %>
        <s-icon type="alert-circle" tone="critical"></s-icon>
        <% end %>
      </s-stack>
    </s-stack>

    <s-stack direction="block" gap="extra-tight">
      <s-paragraph>Total Scans</s-paragraph>
      <strong><%= @product_page.scans.count %></strong>
    </s-stack>
  </s-grid>
</s-section>

<!-- Open Issues -->
<s-box paddingBlockStart="base">
  <s-section heading="Open issues (<%= @open_issues.count %>)">
    <% if @open_issues.any? %>
    <s-stack gap="none">
      <% @open_issues.each do |issue| %>
      <%= link_to issue_path(issue, host: @host), style: "display: block; text-decoration: none; color: inherit;" do %>
      <s-box border="base" padding="base">
        <s-grid gridTemplateColumns="1fr auto" gap="base" alignItems="center">
          <s-stack direction="block" gap="extra-tight">
            <strong><%= issue.title %></strong>
            <s-stack direction="inline" gap="tight" align="center">
              <s-badge tone="<%= issue.severity == 'high' ? 'critical' : (issue.severity == 'medium' ? 'warning' : 'attention') %>"><%= issue.severity_label %></s-badge>
              <s-paragraph>
                <% parts = ["First detected #{time_ago_in_words(issue.first_detected_at)} ago"] %>
                <% parts << "Seen #{issue.occurrence_count} times" if issue.occurrence_count > 1 %>
                <%= parts.join(' · ') %>
              </s-paragraph>
            </s-stack>
          </s-stack>
          <s-paragraph>View Details →</s-paragraph>
        </s-grid>
      </s-box>
      <% end %>
      <% end %>
    </s-stack>
    <% else %>
    <s-grid gap="base" justifyItems="center" paddingBlock="large-400">
      <s-box maxInlineSize="120px" maxBlockSize="120px">
        <s-icon type="check-circle-filled" tone="success"></s-icon>
      </s-box>
      <s-grid justifyItems="center" maxInlineSize="450px" gap="base">
        <s-stack align="center" gap="tight">
          <s-heading>No open issues</s-heading>
          <s-paragraph>This product page is healthy.</s-paragraph>
        </s-stack>
      </s-grid>
    </s-grid>
    <% end %>
  </s-section>
</s-box>

<!-- Recent Scans -->
<s-box paddingBlockStart="base">
  <s-section heading="Recent scans">
    <% if @recent_scans.any? %>
    <s-stack gap="none">
      <% @recent_scans.each do |scan| %>
      <%= link_to scan_path(scan, host: @host), style: "display: block; text-decoration: none; color: inherit;" do %>
      <s-box border="base" padding="base">
        <s-grid gridTemplateColumns="1fr auto" gap="base" alignItems="center">
          <s-stack direction="block" gap="extra-tight">
            <strong>Scan #<%= scan.id %></strong>
            <s-stack direction="inline" gap="tight" align="center">
              <s-badge tone="<%= scan.status == 'completed' ? 'success' : (scan.status == 'failed' ? 'critical' : 'info') %>"><%= scan.status.capitalize %></s-badge>
              <s-paragraph>
                <% parts = ["#{time_ago_in_words(scan.created_at)} ago"] %>
                <% parts << "#{(scan.page_load_time_ms / 1000.0).round(1)}s load time" if scan.page_load_time_ms %>
                <% parts << "#{scan.issues.count} issue#{scan.issues.count > 1 ? 's' : ''} detected" if scan.issues.any? %>
                <%= parts.join(' · ') %>
              </s-paragraph>
            </s-stack>
          </s-stack>
          <s-badge tone="<%= scan.status == 'completed' ? 'success' : (scan.status == 'failed' ? 'critical' : 'info') %>"><%= scan.status.capitalize %></s-badge>
        </s-grid>
      </s-box>
      <% end %>
      <% end %>
    </s-stack>
    <% else %>
    <s-grid gap="base" justifyItems="center" paddingBlock="large-400">
      <s-box maxInlineSize="120px" maxBlockSize="120px">
        <s-icon type="clock" tone="subdued"></s-icon>
      </s-box>
      <s-grid justifyItems="center" maxInlineSize="450px" gap="base">
        <s-stack align="center" gap="tight">
          <s-heading>No scans yet</s-heading>
          <s-paragraph>The first scan will run automatically soon.</s-paragraph>
        </s-stack>
      </s-grid>
    </s-grid>
    <% end %>
  </s-section>
</s-box>

<% content_for :javascript do %>
<script>
  (function() {
    const config    = document.getElementById('status-config');
    const statusUrl = config.dataset.statusUrl;
    const rescanUrl = config.dataset.rescanUrl;
    const csrfToken = config.dataset.csrf;
    const isScanning = config.dataset.scanning === 'true';

    // ── Rescan Now button ────────────────────────────────────────────────────
    async function rescanNow(btn) {
      btn.loading = true;

      try {
        const headers = { 'X-CSRF-Token': csrfToken, 'Accept': 'text/html' };
        try {
          const token = await shopify.idToken();
          if (token) headers['Authorization'] = `Bearer ${token}`;
        } catch (e) { console.warn('idToken failed:', e); }

        shopify.toast.show('Rescan queued! This may take a minute.', { duration: 3000 });

        const response = await fetch(rescanUrl, {
          method: 'POST',
          headers,
          credentials: 'same-origin',
          redirect: 'manual'
        });

        if (response.ok || response.type === 'opaqueredirect' || (response.status >= 300 && response.status < 400)) {
          // Reload so the scanning banner appears and polling kicks in
          setTimeout(() => window.location.reload(), 300);
        } else {
          throw new Error(`Server returned ${response.status}`);
        }
      } catch (error) {
        console.error('Rescan failed:', error);
        btn.loading = false;
        shopify.toast.show('Failed to start rescan. Please try again.', { duration: 3000, isError: true });
      }
    }

    window.rescanNow = rescanNow;

    // ── Scan progress polling ────────────────────────────────────────────────
    if (!isScanning) return;

    const POLL_INTERVAL_MS = 3000;   // check every 3 seconds
    const MAX_POLL_MS      = 120000; // give up after 2 minutes
    let elapsed = 0;
    let pollTimer;

    async function pollStatus() {
      try {
        const response = await fetch(statusUrl, {
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });

        if (!response.ok) return; // transient error — keep polling

        const data = await response.json();

        if (!data.scanning) {
          clearInterval(pollTimer);
          shopify.toast.show('Scan complete! Refreshing…', { duration: 2000 });
          setTimeout(() => window.location.reload(), 800);
          return;
        }
      } catch (e) {
        console.warn('Status poll error:', e);
      }

      elapsed += POLL_INTERVAL_MS;
      if (elapsed >= MAX_POLL_MS) {
        clearInterval(pollTimer);
        shopify.toast.show(
          'Scan is taking longer than expected. Refresh the page to check results.',
          { duration: 6000 }
        );
      }
    }

    pollStatus();
    pollTimer = setInterval(pollStatus, POLL_INTERVAL_MS);
  })();
</script>
<% end %>