<%# Product Pages Index - List of monitored PDPs %>

<s-page heading="Monitored Pages">
  <% if @can_add_more %>
    <s-link slot="primary-action" href="<%= new_product_page_path(host: @host) %>">Add Product</s-link>
  <% end %>
  <s-link slot="breadcrumb-actions" href="<%= root_path(host: @host) %>">Dashboard</s-link>
  <s-badge slot="accessory" tone="info"><%= @product_pages_count %>/<%= @shop_setting&.max_monitored_pages || 5 %></s-badge>
</s-page>

<div class="issues-list">
  <% if @product_pages_count > 0 %>
    <% @product_pages.each do |page| %>
      <div class="issue-item" style="cursor: default;">
        <div class="issue-severity <%= page.status %>"></div>
        <div class="issue-content">
          <%= link_to product_page_path(page, host: @host), style: "text-decoration: none; color: inherit;" do %>
            <p class="issue-title"><%= page.title %></p>
            <p class="issue-meta">
              <%= page.handle %> â€¢ 
              <% if page.last_scanned_at %>
                Last scanned <%= time_ago_in_words(page.last_scanned_at) %> ago
              <% else %>
                Never scanned
              <% end %>
              <% high_severity_count = @high_severity_counts[page.id] || 0 %>
              <% if high_severity_count > 0 %>
                â€¢ <%= high_severity_count %> critical issue<%= high_severity_count > 1 ? 's' : '' %>
              <% end %>
            </p>
          <% end %>
        </div>
          <span class="badge badge-<%= page.status == 'healthy' ? 'healthy' : (page.status == 'critical' ? 'critical' : (page.status == 'warning' ? 'warning' : 'pending')) %>">
            <%= page.status.capitalize %>
          </span>
        <s-stack direction="inline" gap="small-300">
          <s-button href="<%= product_page_path(page, host: @host) %>">View</s-button>
          <s-button onclick="document.getElementById('rescan-form-<%= page.id %>').submit()">Rescan</s-button>
          <s-button tone="critical" variant="primary" onclick="if(confirm('Remove <%= page.title %> from monitoring?')) document.getElementById('delete-form-<%= page.id %>').submit()">Remove</s-button>

          <form id="rescan-form-<%= page.id %>" action="<%= rescan_product_page_path(page, host: @host) %>" method="post" style="display: none;">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          </form>

          <form id="delete-form-<%= page.id %>" action="<%= product_page_path(page, host: @host) %>" method="post" style="display: none;">
            <input type="hidden" name="_method" value="delete">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          </form>
        </s-stack>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“¦</div>
      <h3 class="empty-state-title">No product pages monitored yet</h3>
      <p class="empty-state-description">Add up to 5 product pages to start monitoring their health.</p>
      <s-button variant="primary" href="<%= new_product_page_path(host: @host) %>">Add Product Page</s-button>
    </div>
  <% end %>
</div>
